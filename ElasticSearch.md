
# ElasticSearch

## ES为什么快
## ES在项目用的作用

## 为什么使用ES、不适用mysql进行查找

## 倒排索引

传统数据库（MYSQL）采用正向索引，即根据选择的字段，从小到大的排序

ES采用的是倒排索引，首先会将文档（即每条数据）中的内容划分为数个词条，并以`（词条：文档id）`的形式记录数据。
对查询的数据，会对其进行分词，并去词条列表查询文档id，得到每个词条所在的文档id，将相关文档放入结果集。

在ES中，索引为相同类型的文档的集合，而映射（Mapping）即索引中文档的字段约束信息，类似数据库表中的结构约束

正向索引：根据id搜索数据
倒排索引：根据数据内容找到文档对应的id

## 为什么不用Mysql，要用ES？



## ES是怎样数据同步的

ES的数据源于MySQL数据库，当MySQl数据发生改变时，ES也必须改变，两者的同步即数据同步

方案：
- 同步存储
- 通过MQ实现异步的通知
- 监听mysql的binlog（mysql会将更改数据的操作记录在binlog中）

## ES集群

ES集群的职责划分：
| 节点类型 | 配置参数 | 默认值 | 节点职责 |
|--|--|--|--|
|  master eligible(备份节点) |  node.master  |  true  |  备选主节点：主节点可以管理和记录集群状态、决定分片在哪个节点、处理创建和删除索引库的请求  |
|  data  |  node.data  |  true  |  数据节点：存储数据、搜索、聚合、CRUD  |
|  ingest  |  node.ingest  |  true  |  数据存储前的预处理  |
|  coordinating  |  上面三个参数都为false，则为coordinating节点  |  无  |  将收到的路由请求到其他节点；合并其他节点处理的结果，返回给用户  |

## 脑裂问题

默认情况下，每个节点都是master eligible节点，一旦部分节点无法与master节点连接，其他候选节点会选举为主节点，导致集群出现两个master节点

为了避免脑裂，需要选票数超过`(eligible节点数量 + 1) / 2`才能当选，因此eligible节点数量最好是奇数


## 分布式存储


分布式新增过程：
新增数据时，应该保存到不同分配，保证数据均衡，coordinating node确定数据存储在哪个分片的方式如下：

ES会通过hash算法计算文档应该存储到哪个分片`shard = hash(_routing) % number_of_shards`
其中：
- `_routing`默认为文档的id
- 算法与分片数量有关，因此索引库一旦创建，分片数量不能改变

分布式查询过程：
ES的查询分为两个阶段：
1. scatter phase：分散阶段，coordinating node会把请求分发到**每一个分片**
2. gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户


## 故障转移

集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其他节点，确保数据安全，即故障转移
